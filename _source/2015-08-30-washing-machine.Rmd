---
layout: post
title:  "Washing apparatus ready detection (WARD)"
date:   2015-08-30 21:53:48
categories: R PocketLab
---

## Abstract

Using a [PocketLab](http://thepocketlab.com/) put on the top of a washing machine, we measure the magnetic field generated by the motor. The magnitude of this vector is used to detect if the motor is on, and when the motor has been off for some time, we say that the cycle is finished.

## Checkpoint

```{r, checkpoint}
#library(checkpoint)
#checkpoint("2015-08-26")
```

## Libraries

```{r, libraries, message=F}
library(dplyr)
library(tidyr)
library(ggplot2)
library(TTR)
library(printr)

#library(mime)
```

## Helpers

## Read data

Read data from PocketLab CSV and calculate magnitude from `x`, `y` and `z` components. Then use an Exponential Moving Average filter to remove the trend (seems like the sensor does not return to zero when the washing machine motor turns off).

```{r read}
wash <- read.csv("data/Magnetic field368141090.csv", col.names=c("time", "x", "y","z")) %>%
	mutate(
		magnitude = sqrt(x^2 + y^2 + z^2), # Calculate magnitude
		magnitude_ema = EMA(magnitude,20), # Exponential Moving Average
		magnitude_adj = magnitude - magnitude_ema, # Remove trend
		magnitude_abs = magnitude_adj %>% abs %>% EMA(., 50),
		magnitude_abs = scale(magnitude_abs) %>% as.vector, # Absolute value and more EMA
		threshold = ifelse(magnitude_abs > 0, 1, 0)
	) %>%
	filter(time < 1190)

wash %>% head
```

Rearrange and plot `x`,`y` and `z` components.

```{r mag_axis, fig.width=16, fig.height=5}
wash2 <- wash %>% select(-matches("magnitude"), -threshold) %>% gather("axis", "value",-time) 

ggplot(wash2, aes(x=time, y=value, color=axis)) +
	geom_line() +
	theme_classic() +
	facet_grid(axis~.) +
	scale_colour_brewer(palette = "Set1")
```

Plot the magnitude

```{r mag1, fig.width=16, fig.height=5}
ggplot(wash, aes(x=time, y=magnitude)) +
	geom_line() +
	theme_classic() 
```

Plot the magnitude trend

```{r mag2, fig.width=16, fig.height=5}
ggplot(wash, aes(x=time, y=magnitude_ema)) +
	geom_line() +
	theme_classic()
```

Plot the adjusted magnitude (removed magnitude trend).

```{r mag3, fig.width=16, fig.height=5}
ggplot(wash, aes(x=time, y=magnitude_adj)) +
	geom_line() +
	theme_classic()
```

Plot the normalized absolute magnitude.

```{r mag4, fig.width=16, fig.height=5}
ggplot(wash, aes(x=time, y=magnitude_abs)) + 
	geom_line() +
	theme_classic() 
```

Using zero as a threshold, plot on or off status.

```{r mag5, fig.width=16, fig.height=2}
ggplot(wash, aes(x=time, y=threshold)) + geom_line()+ theme_classic() 
```



